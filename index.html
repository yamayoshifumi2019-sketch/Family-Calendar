<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Calendar</title>
    <!-- Supabase JS Client (loaded before our script) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* CSS Variables */
        :root {
            --primary-color: #4A90D9;
            --primary-hover: #3A7BC8;
            --secondary-color: #6c757d;
            --danger-color: #D94A4A;
            --danger-hover: #C43A3A;
            --background: #f5f7fa;
            --surface: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.15);
            --radius: 8px;
            --radius-sm: 4px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.5;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 8px;
            gap: 8px;
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .app-header h1 { font-size: 1.5rem; color: var(--primary-color); }

        .user-section { display: flex; align-items: center; gap: 12px; }
        .login-section { display: flex; align-items: center; gap: 8px; }
        .user-info { display: flex; align-items: center; gap: 12px; }

        #user-name-display {
            font-weight: 600;
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            background: var(--background);
        }

        #user-select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 14px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-secondary { background: var(--secondary-color); color: white; }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-nav {
            background: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }
        .btn-nav:hover { background: var(--primary-color); color: white; }

        .main-content { display: flex; flex-direction: column; flex: 1; gap: 8px; min-height: 0; }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding: 8px 12px;
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 14px; }
        .legend-color { width: 16px; height: 16px; border-radius: 50%; }

        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            background: var(--surface);
            border-radius: var(--radius) var(--radius) 0 0;
            border-bottom: 1px solid var(--border-color);
        }
        .calendar-nav h2 { font-size: 1.25rem; }

        .calendar-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            background: var(--surface);
            border-radius: 0 0 var(--radius) var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            min-height: 0;
        }

        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: var(--background);
            border-bottom: 1px solid var(--border-color);
        }
        .day-header {
            padding: 10px 4px;
            text-align: center;
            font-weight: 600;
            font-size: 16px;
            color: var(--text-secondary);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-auto-rows: 1fr;
            flex: 1;
            overflow: hidden;
        }

        .calendar-day {
            padding: 4px;
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .calendar-day:nth-child(7n) { border-right: none; }
        .calendar-day:hover { background: var(--background); }
        .calendar-day.other-month { background: #fafafa; color: #aaa; }
        .calendar-day.today { background: #fff9e6; }
        .calendar-day.today .day-number {
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .day-number { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
        .day-events { display: flex; flex-direction: column; gap: 2px; overflow-y: auto; flex: 1; }

        .event-pill {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            font-size: 28px;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            z-index: 100;
        }
        .fab:hover { background: var(--primary-hover); }

        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 16px;
        }
        .modal-content {
            background: var(--surface);
            border-radius: var(--radius);
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .btn-close {
            background: transparent;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 6px; font-size: 14px; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 14px;
        }
        .form-row { display: flex; gap: 12px; }
        .form-row .form-group { flex: 1; }

        #event-form { padding: 20px; }
        .modal-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }
        .modal-actions-right { display: flex; gap: 8px; }

        .events-list { padding: 16px 20px; }
        .event-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            background: var(--background);
            cursor: pointer;
        }
        .event-item:hover { background: #e8e8e8; }
        .event-color-bar { width: 4px; min-height: 40px; border-radius: 2px; }
        .event-details { flex: 1; }
        .event-title { font-weight: 600; font-size: 14px; }
        .event-meta { font-size: 12px; color: var(--text-secondary); }

        .hidden { display: none !important; }

        @media (max-width: 768px) {
            html, body { overflow: auto; }
            .app-container { height: auto; min-height: 100vh; }
            .app-header { flex-direction: column; gap: 8px; }
            .calendar-grid { min-height: 400px; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1>Family Calendar</h1>
            <div class="user-section">
                <div id="login-section" class="login-section">
                    <select id="user-select"></select>
                    <button id="login-btn" class="btn btn-primary">Login</button>
                </div>
                <div id="user-info" class="user-info hidden">
                    <span id="user-name-display"></span>
                    <button id="logout-btn" class="btn btn-secondary">Logout</button>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="legend" id="legend"></div>

            <div class="calendar-nav">
                <button id="prev-month" class="btn btn-nav">&lt; Prev</button>
                <h2 id="current-month-year"></h2>
                <button id="next-month" class="btn btn-nav">Next &gt;</button>
            </div>

            <div class="calendar-container">
                <div class="calendar-header">
                    <div class="day-header">Sun</div>
                    <div class="day-header">Mon</div>
                    <div class="day-header">Tue</div>
                    <div class="day-header">Wed</div>
                    <div class="day-header">Thu</div>
                    <div class="day-header">Fri</div>
                    <div class="day-header">Sat</div>
                </div>
                <div class="calendar-grid" id="calendar-grid"></div>
            </div>
        </main>

        <button id="add-event-btn" class="fab hidden">+</button>

        <!-- Add/Edit Event Modal -->
        <div id="event-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modal-title">Add Event</h3>
                    <button id="close-modal" class="btn-close">&times;</button>
                </div>
                <form id="event-form">
                    <input type="hidden" id="event-id">
                    <div class="form-group">
                        <label for="event-title">Title *</label>
                        <input type="text" id="event-title" required placeholder="Event title">
                    </div>
                    <div class="form-group">
                        <label for="event-date">Date *</label>
                        <input type="date" id="event-date" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="event-start-time">Start Time</label>
                            <input type="time" id="event-start-time">
                        </div>
                        <div class="form-group">
                            <label for="event-end-time">End Time</label>
                            <input type="time" id="event-end-time">
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button type="button" id="delete-event-btn" class="btn btn-danger hidden">Delete</button>
                        <div class="modal-actions-right">
                            <button type="button" id="cancel-btn" class="btn btn-secondary">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Day Events Modal -->
        <div id="day-events-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="day-events-title">Events</h3>
                    <button id="close-day-modal" class="btn-close">&times;</button>
                </div>
                <div id="day-events-list" class="events-list"></div>
                <div style="padding: 0 20px 20px;">
                    <button id="add-event-day-btn" class="btn btn-primary">Add Event</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===================
        // Supabase Configuration
        // ===================
        // IMPORTANT: Replace these with your Supabase project credentials
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';       // e.g., 'https://xxxxx.supabase.co'
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';  // Your anon/public key

        // Supabase client (initialized in init)
        let supabase = null;
        let useSupabase = false;  // Will be set to true if Supabase connects successfully

        // ===================
        // Configuration
        // ===================
        const FAMILY_MEMBERS = [
            { id: 1, name: 'King', color: '#4A90D9' },
            { id: 2, name: 'ブー太郎', color: '#D94A4A' },
            { id: 3, name: 'Hidetoshi', color: '#4AD97B' },
            { id: 4, name: 'Yoshi', color: '#D9A84A' },
        ];

        const MONTH_NAMES = ['January', 'February', 'March', 'April', 'May', 'June',
                             'July', 'August', 'September', 'October', 'November', 'December'];

        const STORAGE_KEYS = {
            USER: 'family_calendar_user'
        };

        // ===================
        // State
        // ===================
        const state = {
            currentUser: null,
            events: [],
            currentYear: new Date().getFullYear(),
            currentMonth: new Date().getMonth(),
            selectedDate: null
        };

        // ===================
        // Supabase Functions
        // ===================
        async function initSupabase() {
            // Check if credentials are configured
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                console.warn('[Supabase] Credentials not configured - using localStorage only');
                return false;
            }

            // Check if Supabase library loaded
            if (typeof window.supabase === 'undefined') {
                console.error('[Supabase] Library not loaded - using localStorage only');
                return false;
            }

            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('[Supabase] Client created, testing connection...');

                // Test connection with a simple query
                const { error } = await supabase.from('events').select('id').limit(1);
                if (error) {
                    console.error('[Supabase] Connection test failed:', error.message);
                    return false;
                }

                console.log('[Supabase] Connected successfully!');
                return true;
            } catch (e) {
                console.error('[Supabase] Failed to initialize:', e);
                return false;
            }
        }

        async function loadEventsFromSupabase() {
            console.log('[Supabase] Loading all events...');
            try {
                const { data, error } = await supabase
                    .from('events')
                    .select('*')
                    .order('date')
                    .order('start_time');

                if (error) throw error;

                state.events = data || [];
                console.log('[Supabase] Loaded', state.events.length, 'events');
                return true;
            } catch (e) {
                console.error('[Supabase] Failed to load events:', e);
                return false;
            }
        }

        async function createEventInSupabase(eventData) {
            console.log('[Supabase] Creating event...');
            try {
                const { data, error } = await supabase
                    .from('events')
                    .insert([{
                        title: eventData.title,
                        date: eventData.date,
                        start_time: eventData.start_time,
                        end_time: eventData.end_time,
                        created_by: eventData.created_by
                    }])
                    .select()
                    .single();

                if (error) throw error;

                console.log('[Supabase] Created event:', data.id);
                return data;
            } catch (e) {
                console.error('[Supabase] Failed to create event:', e);
                throw e;
            }
        }

        async function updateEventInSupabase(eventId, eventData) {
            console.log('[Supabase] Updating event:', eventId);
            try {
                const { data, error } = await supabase
                    .from('events')
                    .update({
                        title: eventData.title,
                        date: eventData.date,
                        start_time: eventData.start_time,
                        end_time: eventData.end_time
                    })
                    .eq('id', eventId)
                    .select()
                    .single();

                if (error) throw error;

                console.log('[Supabase] Updated event:', eventId);
                return data;
            } catch (e) {
                console.error('[Supabase] Failed to update event:', e);
                throw e;
            }
        }

        async function deleteEventFromSupabase(eventId) {
            console.log('[Supabase] Deleting event:', eventId);
            try {
                const { error } = await supabase
                    .from('events')
                    .delete()
                    .eq('id', eventId);

                if (error) throw error;

                console.log('[Supabase] Deleted event:', eventId);
                return true;
            } catch (e) {
                console.error('[Supabase] Failed to delete event:', e);
                throw e;
            }
        }

        // ===================
        // User Storage (always localStorage)
        // ===================
        function saveUser() {
            if (state.currentUser) {
                localStorage.setItem(STORAGE_KEYS.USER, JSON.stringify(state.currentUser));
            } else {
                localStorage.removeItem(STORAGE_KEYS.USER);
            }
        }

        function loadUser() {
            try {
                const data = localStorage.getItem(STORAGE_KEYS.USER);
                if (data) {
                    const saved = JSON.parse(data);
                    state.currentUser = FAMILY_MEMBERS.find(u => u.id === saved.id) || null;
                }
            } catch (e) {
                console.error('[Storage] Failed to load user:', e);
            }
        }

        // ===================
        // Helper Functions
        // ===================
        function getNextEventId() {
            if (state.events.length === 0) return 1;
            return Math.max(...state.events.map(e => e.id)) + 1;
        }

        function formatTime(time) {
            if (!time) return '';
            const [h, m] = time.split(':');
            const hour = parseInt(h);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            return `${hour % 12 || 12}:${m} ${ampm}`;
        }

        function formatDate(year, month, day) {
            return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }

        function isToday(year, month, day) {
            const today = new Date();
            return today.getFullYear() === year && today.getMonth() === month && today.getDate() === day;
        }

        function getEventsForDate(dateStr) {
            return state.events.filter(e => e.date === dateStr);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ===================
        // Rendering
        // ===================
        function renderUserSection() {
            const loginSection = document.getElementById('login-section');
            const userInfo = document.getElementById('user-info');
            const addBtn = document.getElementById('add-event-btn');
            const nameDisplay = document.getElementById('user-name-display');

            if (state.currentUser) {
                loginSection.classList.add('hidden');
                userInfo.classList.remove('hidden');
                addBtn.classList.remove('hidden');
                nameDisplay.textContent = state.currentUser.name;
                nameDisplay.style.borderLeft = `4px solid ${state.currentUser.color}`;
            } else {
                loginSection.classList.remove('hidden');
                userInfo.classList.add('hidden');
                addBtn.classList.add('hidden');
            }
        }

        function renderUserSelect() {
            const select = document.getElementById('user-select');
            select.innerHTML = '<option value="">Select Family Member</option>';
            FAMILY_MEMBERS.forEach(user => {
                select.innerHTML += `<option value="${user.id}">${user.name}</option>`;
            });
        }

        function renderLegend() {
            const legend = document.getElementById('legend');
            legend.innerHTML = FAMILY_MEMBERS.map(user => `
                <div class="legend-item">
                    <span class="legend-color" style="background-color: ${user.color}"></span>
                    <span>${user.name}</span>
                </div>
            `).join('');
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const monthYear = document.getElementById('current-month-year');

            monthYear.textContent = `${MONTH_NAMES[state.currentMonth]} ${state.currentYear}`;
            grid.innerHTML = '';

            const daysInMonth = new Date(state.currentYear, state.currentMonth + 1, 0).getDate();
            const firstDay = new Date(state.currentYear, state.currentMonth, 1).getDay();

            // Previous month days
            const prevMonth = state.currentMonth === 0 ? 11 : state.currentMonth - 1;
            const prevYear = state.currentMonth === 0 ? state.currentYear - 1 : state.currentYear;
            const daysInPrevMonth = new Date(prevYear, prevMonth + 1, 0).getDate();

            for (let i = firstDay - 1; i >= 0; i--) {
                grid.appendChild(createDayElement(prevYear, prevMonth, daysInPrevMonth - i, true));
            }

            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                grid.appendChild(createDayElement(state.currentYear, state.currentMonth, day, false));
            }

            // Next month days
            const totalCells = grid.children.length;
            const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            const nextMonth = state.currentMonth === 11 ? 0 : state.currentMonth + 1;
            const nextYear = state.currentMonth === 11 ? state.currentYear + 1 : state.currentYear;

            for (let day = 1; day <= remaining; day++) {
                grid.appendChild(createDayElement(nextYear, nextMonth, day, true));
            }

            console.log('[Render] Calendar rendered for', MONTH_NAMES[state.currentMonth], state.currentYear);
        }

        function createDayElement(year, month, day, isOtherMonth) {
            const el = document.createElement('div');
            el.className = 'calendar-day';
            if (isOtherMonth) el.classList.add('other-month');
            if (isToday(year, month, day)) el.classList.add('today');

            const dateStr = formatDate(year, month, day);
            const events = getEventsForDate(dateStr);

            el.innerHTML = `<div class="day-number">${day}</div>`;

            if (events.length > 0) {
                const eventsDiv = document.createElement('div');
                eventsDiv.className = 'day-events';
                events.slice(0, 3).forEach(event => {
                    const user = FAMILY_MEMBERS.find(u => u.name === event.created_by);
                    const color = user ? user.color : '#888';
                    eventsDiv.innerHTML += `<div class="event-pill" style="background:${color}">${escapeHtml(event.title)}</div>`;
                });
                if (events.length > 3) {
                    eventsDiv.innerHTML += `<div style="font-size:11px;color:#666;">+${events.length - 3} more</div>`;
                }
                el.appendChild(eventsDiv);
            }

            el.onclick = () => handleDayClick(dateStr, events);
            return el;
        }

        // ===================
        // Event Handlers
        // ===================
        function handleDayClick(dateStr, events) {
            state.selectedDate = dateStr;
            if (events.length > 0) {
                showDayEventsModal(dateStr, events);
            } else if (state.currentUser) {
                openEventModal(null, dateStr);
            } else {
                alert('Please log in to add events.');
            }
        }

        function showDayEventsModal(dateStr, events) {
            const modal = document.getElementById('day-events-modal');
            const title = document.getElementById('day-events-title');
            const list = document.getElementById('day-events-list');
            const addBtn = document.getElementById('add-event-day-btn');

            title.textContent = new Date(dateStr + 'T00:00:00').toLocaleDateString('en-US', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });

            list.innerHTML = events.map(event => {
                const user = FAMILY_MEMBERS.find(u => u.name === event.created_by);
                const color = user ? user.color : '#888';
                const canEdit = state.currentUser && state.currentUser.name === event.created_by;
                const timeStr = event.start_time ? formatTime(event.start_time) : '';

                return `
                    <div class="event-item" style="cursor:${canEdit ? 'pointer' : 'default'}"
                         onclick="${canEdit ? `editEvent(${event.id})` : ''}">
                        <div class="event-color-bar" style="background:${color}"></div>
                        <div class="event-details">
                            <div class="event-title">${escapeHtml(event.title)}</div>
                            <div class="event-meta">${timeStr ? timeStr + ' • ' : ''}${event.created_by}</div>
                        </div>
                    </div>
                `;
            }).join('');

            addBtn.classList.toggle('hidden', !state.currentUser);
            modal.classList.remove('hidden');
        }

        function closeDayEventsModal() {
            document.getElementById('day-events-modal').classList.add('hidden');
        }

        function openEventModal(event = null, date = null) {
            if (!state.currentUser) {
                alert('Please log in first.');
                return;
            }

            const modal = document.getElementById('event-modal');
            const form = document.getElementById('event-form');
            const title = document.getElementById('modal-title');
            const deleteBtn = document.getElementById('delete-event-btn');

            form.reset();
            document.getElementById('event-id').value = '';

            if (event) {
                title.textContent = 'Edit Event';
                document.getElementById('event-id').value = event.id;
                document.getElementById('event-title').value = event.title;
                document.getElementById('event-date').value = event.date;
                document.getElementById('event-start-time').value = event.start_time || '';
                document.getElementById('event-end-time').value = event.end_time || '';
                deleteBtn.classList.remove('hidden');
            } else {
                title.textContent = 'Add Event';
                document.getElementById('event-date').value = date || formatDate(state.currentYear, state.currentMonth, new Date().getDate());
                deleteBtn.classList.add('hidden');
            }

            modal.classList.remove('hidden');
            document.getElementById('event-title').focus();
        }

        function closeEventModal() {
            document.getElementById('event-modal').classList.add('hidden');
        }

        function editEvent(eventId) {
            closeDayEventsModal();
            const event = state.events.find(e => e.id === eventId);
            if (event) openEventModal(event);
        }

        async function handleEventSubmit(e) {
            e.preventDefault();

            const id = document.getElementById('event-id').value;
            const eventData = {
                title: document.getElementById('event-title').value.trim(),
                date: document.getElementById('event-date').value,
                start_time: document.getElementById('event-start-time').value || null,
                end_time: document.getElementById('event-end-time').value || null,
                created_by: state.currentUser.name
            };

            try {
                if (useSupabase) {
                    // Use Supabase
                    if (id) {
                        await updateEventInSupabase(id, eventData);
                    } else {
                        await createEventInSupabase(eventData);
                    }
                    // Reload all events from Supabase
                    await loadEventsFromSupabase();
                } else {
                    // Use local state (no persistence without Supabase)
                    if (id) {
                        const index = state.events.findIndex(e => e.id === id || e.id === parseInt(id));
                        if (index !== -1) {
                            state.events[index] = { ...state.events[index], ...eventData };
                            console.log('[Local] Updated event', id);
                        }
                    } else {
                        eventData.id = getNextEventId();
                        eventData.created_at = new Date().toISOString();
                        state.events.push(eventData);
                        console.log('[Local] Created event', eventData.id);
                    }
                }

                renderCalendar();
                closeEventModal();
            } catch (error) {
                alert('Failed to save event: ' + error.message);
            }
        }

        async function handleEventDelete() {
            const id = document.getElementById('event-id').value;
            if (!id || !confirm('Delete this event?')) return;

            try {
                if (useSupabase) {
                    await deleteEventFromSupabase(id);
                    await loadEventsFromSupabase();
                } else {
                    state.events = state.events.filter(e => e.id !== id && e.id !== parseInt(id));
                    console.log('[Local] Deleted event', id);
                }

                renderCalendar();
                closeEventModal();
            } catch (error) {
                alert('Failed to delete event: ' + error.message);
            }
        }

        function goToPrevMonth() {
            if (state.currentMonth === 0) {
                state.currentMonth = 11;
                state.currentYear--;
            } else {
                state.currentMonth--;
            }
            renderCalendar();
        }

        function goToNextMonth() {
            if (state.currentMonth === 11) {
                state.currentMonth = 0;
                state.currentYear++;
            } else {
                state.currentMonth++;
            }
            renderCalendar();
        }

        // ===================
        // Initialization
        // ===================
        async function init() {
            console.log('[Init] Starting...');

            // ALWAYS render UI first - calendar must never be blank
            try {
                loadUser();
                renderUserSelect();
                renderLegend();
                renderUserSection();
                state.events = [];  // Start with empty events
                renderCalendar();
                console.log('[Init] UI rendered successfully');
            } catch (uiError) {
                console.error('[Init] UI render failed:', uiError);
                return;  // Critical failure
            }

            // Setup event listeners (must always happen)
            document.getElementById('login-btn').onclick = () => {
                const id = parseInt(document.getElementById('user-select').value);
                if (!id) return alert('Please select a family member');
                state.currentUser = FAMILY_MEMBERS.find(u => u.id === id);
                saveUser();
                renderUserSection();
            };

            document.getElementById('logout-btn').onclick = () => {
                state.currentUser = null;
                saveUser();
                renderUserSection();
            };

            document.getElementById('prev-month').onclick = goToPrevMonth;
            document.getElementById('next-month').onclick = goToNextMonth;

            document.getElementById('add-event-btn').onclick = () => {
                openEventModal(null, formatDate(state.currentYear, state.currentMonth, new Date().getDate()));
            };

            document.getElementById('event-form').onsubmit = handleEventSubmit;
            document.getElementById('delete-event-btn').onclick = handleEventDelete;
            document.getElementById('close-modal').onclick = closeEventModal;
            document.getElementById('cancel-btn').onclick = closeEventModal;

            document.getElementById('close-day-modal').onclick = closeDayEventsModal;
            document.getElementById('add-event-day-btn').onclick = () => {
                closeDayEventsModal();
                openEventModal(null, state.selectedDate);
            };

            document.getElementById('event-modal').onclick = (e) => {
                if (e.target.id === 'event-modal') closeEventModal();
            };
            document.getElementById('day-events-modal').onclick = (e) => {
                if (e.target.id === 'day-events-modal') closeDayEventsModal();
            };

            // NOW try to connect to Supabase (non-blocking for UI)
            try {
                useSupabase = await initSupabase();
                if (useSupabase) {
                    await loadEventsFromSupabase();
                    renderCalendar();  // Re-render with loaded events
                    console.log('[Init] Supabase connected, events loaded');
                } else {
                    console.log('[Init] No Supabase - local mode only');
                }
            } catch (supabaseError) {
                console.error('[Init] Supabase error (calendar still works):', supabaseError);
                useSupabase = false;
            }

            console.log('[Init] Complete! Calendar is ready.');
        }

        // Start when DOM is ready
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
